#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
äº¤äº’å¼è„šæœ¬: åœ¨ä¸­è‹±æ··æ’æ—¶å¯¹è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ç¬¦å·ä¸ CJK (ä¸­æ—¥éŸ©) å­—ç¬¦ä¹‹é—´æ·»åŠ ç©ºæ ¼
ä¾èµ–: pangu (https://github.com/vinta/pangu.py / https://pypi.org/project/pangu/)
åŠŸèƒ½:
  - ä½¿ç”¨ pangu.spacing_text åšä¸»å¤„ç† (åœ¨ CJK ä¸åŠè§’å­—ç¬¦ä¹‹é—´æ’å…¥ç©ºæ ¼)
  - åœ¨ pangu çš„åŸºç¡€ä¸Šåšè‹¥å¹²ç»†å¾®çš„æ­£åˆ™è§„èŒƒåŒ– (å»é™¤ CJK ä¸å…¨è§’æ ‡ç‚¹ä¹‹é—´å¤šä½™ç©ºæ ¼ã€æŠ˜å è¿ç»­ç©ºæ ¼ç­‰)
  - æä¾›äº¤äº’å¼å¾ªç¯, ç”¨æˆ·è¾“å…¥æ–‡æœ¬å¹¶å¾—åˆ°æ’ç‰ˆç»“æœ; è¾“å…¥ "exit" æˆ– "q" é€€å‡º
"""

# å¯¼å…¥ä¾èµ–åº“
from __future__ import annotations

import re
import sys
import subprocess
import importlib
from typing import Optional


# å®šä¹‰äº†å®Œæ•´çš„ CJK å­—ç¬¦ Unicode èŒƒå›´ (ç”¨äºæ­£åˆ™), ç¡®ä¿å…¨é¢è¦†ç›–ã€‚
_CJK_RANGES = (
    r"\u4E00-\u9FFF"  # å¸¸ç”¨æ±‰å­—
    r"\u3400-\u4DBF"  # æ‰©å±• A
    r"\uF900-\uFAFF"  # å…¼å®¹è¡¨æ„æ–‡å­—
    r"\u3040-\u309F"  # å¹³å‡å
    r"\u30A0-\u30FF"  # ç‰‡å‡å
    r"\uAC00-\uD7AF"  # éŸ©æ–‡éŸ³èŠ‚
)
_CJK_CLASS = f"[{_CJK_RANGES}]"


def ensure_pangu_module() -> Optional[object]:
    """
    ä¾èµ–ç®¡ç†: è‡ªåŠ¨æ£€æµ‹å¹¶å®‰è£…å¿…éœ€çš„ pangu åº“, ç¡®ä¿ pangu æ¨¡å—å¯ç”¨:
      - å…ˆå°è¯•ç›´æ¥ import
      - è‹¥å¤±è´¥, å°è¯•ç”¨å½“å‰ Python è§£é‡Šå™¨è‡ªåŠ¨ pip å®‰è£… `pangu` ç„¶åå†æ¬¡ import
      - è‹¥ä»å¤±è´¥, è¿”å› None (è°ƒç”¨å¤„åº”å‹å¥½æç¤ºç”¨æˆ·æ‰‹åŠ¨å®‰è£…)
    æ³¨æ„: è‡ªåŠ¨å®‰è£…éœ€è¦ç½‘ç»œæƒé™å¹¶ä¸”åœ¨æŸäº›ç¯å¢ƒä¸‹å¯èƒ½å¤±è´¥ (è™šæ‹Ÿç¯å¢ƒã€æ— æƒé™ç­‰) ã€‚
    """
    try:
        import pangu  # type: ignore

        return pangu

    except Exception:
        print("æ£€æµ‹åˆ° pangu æœªå®‰è£…, å°è¯•é€šè¿‡ pip è‡ªåŠ¨å®‰è£… (éœ€è¦ç½‘ç»œ) ...")
        try:
            subprocess.check_call(
                [sys.executable, "-m", "pip", "install", "-U", "pangu"]
            )
            # å°è¯•é‡æ–° import
            importlib.invalidate_caches()
            import pangu  # type: ignore

            print("âœ… pangu å®‰è£…å¹¶å¯¼å…¥æˆåŠŸã€‚")
            return pangu
        except Exception as e:
            print("âŒ è‡ªåŠ¨å®‰è£… pangu å¤±è´¥: ", e)
            print("âœ… è¯·æ‰‹åŠ¨è¿è¡Œ: pip install -U pangu, ç„¶åé‡æ–°è¿è¡Œæ­¤è„šæœ¬ã€‚")
            return None


def normalize_spacing(text: str) -> str:
    """
    æ ¸å¿ƒæ’ç‰ˆé€»è¾‘, åœ¨ pangu å¤„ç†åè¿›è¡Œé¢å¤–çš„æ­£åˆ™è§„èŒƒåŒ–, ç›®æ ‡æ˜¯ â€œåƒç´ çº§â€ / å¼ºè¿«ç—‡çº§åˆ«çš„è§†è§‰æ•´æ´:
      1. æŠŠéæ–­è¡Œç©ºæ ¼æ›¿æ¢ä¸ºæ™®é€šç©ºæ ¼
      2. å»æ‰ CJK ä¸å…¨è§’ (ä¸­æ–‡) æ ‡ç‚¹ä¹‹é—´ä¸å¿…è¦çš„ç©ºæ ¼, ä¾‹å¦‚ "ä½ å¥½ , " -> "ä½ å¥½, "
      3. å»æ‰å…¨è§’æ‹¬å·/å¼•å·å†…å¤–å¤šä½™ç©ºæ ¼, ä¾‹å¦‚ " (  ä»Šå¤©" -> " (ä»Šå¤©", "ä»Šå¤© ) " -> "ä»Šå¤©) "
      4. å»æ‰å¼•å·/ä¹¦åå·å‰åä¸å¿…è¦çš„ç©ºæ ¼ (å°½é‡ä¿æŒä¸­æ–‡æ ‡ç‚¹ä¸ CJK ç´§è´´)
      5. æŠ˜å è¿ç»­å¤šä¸ªç©ºæ ¼ä¸ºå•ä¸ªç©ºæ ¼ (é™¤éç”¨æˆ·åˆ»æ„è¾“å…¥å¤šä¸ªç©ºæ ¼)
      6. ä¸¤ç«¯ strip
    è¿™äº›è§„åˆ™é…åˆ pangu å¯ä»¥è¾¾åˆ°æ›´ç²¾ç»†çš„æ’ç‰ˆæ•ˆæœã€‚
    """
    # 1) ç»Ÿä¸€ç©ºæ ¼å­—ç¬¦ (å°†ä¸åŒç§ç±»çš„ç©ºæ ¼ç»Ÿä¸€ä¸ºæ™®é€šç©ºæ ¼)
    text = text.replace("\u00a0", " ").replace("\u2007", " ").replace("\u202f", " ")

    # 2) å»æ‰ CJK ä¸ä¸­æ–‡æ ‡ç‚¹ä¹‹é—´ä¸å¿…è¦çš„ç©ºæ ¼ (å¸¸è§ä¸­æ–‡å…¨è§’æ ‡ç‚¹)
    #    ä¾‹å¦‚:  "ä½ å¥½ , " æˆ– "ä½ å¥½ ã€‚" -> "ä½ å¥½, " / "ä½ å¥½."
    #    åŒ¹é…: CJK_char ä»»ä½•ç©ºç™½ æ ‡ç‚¹ -> æ›¿æ¢ä¸º CJK_char + æ ‡ç‚¹
    text = re.sub(
        rf"({_CJK_CLASS})\s+([,ï¼Œ.ã€‚!ï¼?ï¼Ÿã€;ï¼›:ï¼šÂ·~ï½â€”â€¦...])",
        r"\1\2",
        text,
    )

    # 3) å»æ‰æ ‡ç‚¹å‰å¤šä½™ç©ºæ ¼ (å¦‚ åŠè§’/å…¨è§’å³æ‹¬å·ç­‰) :
    text = re.sub(r"\s+([) ã€‘ã€‹ã€ã€\]\)\}])", r"\1", text)

    # 4) å»æ‰æ ‡ç‚¹åå¤šä½™ç©ºæ ¼ (å¦‚ å·¦æ‹¬å·/å·¦å¼•å·åä¸åº”æœ‰ç©ºæ ¼)
    text = re.sub(r"([ (ã€ã€Šã€Œã€\[\(\{])\s+", r"\1", text)

    # 5) å¯¹ä¸­æ–‡å¼•å· (â€œâ€ â€˜â€™) çš„å‰åç©ºæ ¼åšå¾®è°ƒ: å»æ‰å¼•å·ä¸ CJK ä¹‹é—´çš„ç©ºæ ¼
    text = re.sub(
        rf"({_CJK_CLASS})\s+([â€œâ€˜])", r"\1\2", text
    )  # CJK + ç©ºæ ¼ + å¼€å¼•å· -> ç´§è´´
    text = re.sub(
        rf"([â€â€™])\s+({_CJK_CLASS})", r"\1\2", text
    )  # å…³å¼•å· + ç©ºæ ¼ + CJK -> ç´§è´´

    # 6) æŠ˜å å¤šä¸ªè¿ç»­ç©ºæ ¼ (ä¸å½±å“æ¢è¡Œ)
    text = re.sub(r" {2,}", " ", text)

    # 7) æ¸…é™¤è¡Œé¦–è¡Œå°¾å¤šä½™ç©ºç™½
    text = text.strip()

    return text


def format_text_with_pangu(pangu_module: object, raw: str) -> str:
    """
    ä¸»å¤„ç†æµç¨‹, å…ˆç”¨ pangu.spacing_text åšä¸»å¤„ç†, ç„¶åè°ƒç”¨ normalize_spacing åšç»†åŒ–æ¸…ç†ã€‚
      - æˆ‘ä»¬æŠŠ pangu çš„ç»“æœè§†ä¸º â€œåŸºç¡€è§„èŒƒåŒ–â€, å†é€šè¿‡é¢å¤–æ­£åˆ™ç¡®ä¿ CJK ä¸å…¨è§’æ ‡ç‚¹
      - ä¹‹é—´æ— å¤šä½™ç©ºæ ¼ç­‰åƒç´ çº§è°ƒæ•´
    """
    # pangu æä¾› spacing_text å‡½æ•° (è¿”å›å¤„ç†åçš„å­—ç¬¦ä¸²)
    try:
        spaced = pangu_module.spacing_text(raw)
    except Exception:
        # è‹¥ pangu çš„ API å¼‚å¸¸, ä¸ºäº†ç¨³å¥æ€§é€€å›åŸå§‹æ–‡æœ¬å¹¶å°½é‡åšæœ€åŸºæœ¬çš„æ¸…ç†
        spaced = raw

    # è¿›ä¸€æ­¥åšç»†èŠ‚å¤„ç†
    final_text = normalize_spacing(spaced)

    return final_text


def main():
    """
    ä¸»å¾ªç¯: äº¤äº’å¼è¯»å–ç”¨æˆ·è¾“å…¥å¹¶è¾“å‡ºæ’ç‰ˆåçš„æ–‡æœ¬, ç›´åˆ°è¾“å…¥ 'exit' æˆ– 'q'ã€‚
      - æä¾›æ˜“ç”¨çš„ç”¨æˆ·äº¤äº’ç•Œé¢
      - å¤„ç†é€€å‡ºæŒ‡ä»¤
      - ä¼˜é›…çš„é”™è¯¯å¤„ç†
    """
    pangu_module = ensure_pangu_module()
    if pangu_module is None:
        # å¦‚æœæ— æ³•å®‰è£…æˆ–å¯¼å…¥ pangu, åˆ™æç¤ºç”¨æˆ·å¹¶ç»§ç»­, ä½†æ’ç‰ˆåŠŸèƒ½ä¼šé™çº§ (ä¸åˆ°ä½)
        print("âŒ è­¦å‘Š: pangu æœªå®‰è£…, è„šæœ¬æ— æ³•ä½¿ç”¨ pangu çš„å®Œæ•´åŠŸèƒ½ã€‚")
        print("âœ… è¯·å…ˆå®‰è£… pangu: pip install -U pangu, ç„¶åé‡æ–°è¿è¡Œã€‚")
        # ä»ç„¶å…è®¸ç”¨æˆ·è¾“å…¥, ä½†æˆ‘ä»¬åªèƒ½åšæœ‰é™çš„æ­£åˆ™æ¸…ç†
    else:
        # ç®€çŸ­æç¤º pangu å·²å¯ç”¨
        print("âœ… å·²å¯ç”¨ pangu æ’ç‰ˆæ”¯æŒã€‚æŒ‰ Ctrl + C æˆ–è¾“å…¥ 'exit'/'q' é€€å‡ºç¨‹åºã€‚")

    try:
        while True:
            print("*" * 100)
            raw = input("ğŸ“ åœ¨è¿™é‡Œè¾“å…¥è¦æ’ç‰ˆçš„æ–‡æœ¬å†…å®¹ (è¾“å…¥ 'exit' æˆ– 'q' é€€å‡º): \n")
            if raw.strip().lower() in ("exit", "q"):
                print("ğŸ‘‹ é€€å‡ºç¨‹åºã€‚ã€‚ã€‚å†è§ï¼ï¼ï¼")
                print("*" * 100)
                break

            if pangu_module is not None:
                out = format_text_with_pangu(pangu_module, raw)
            else:
                # pangu ä¸å¯ç”¨æ—¶, å°½é‡åšæœ€å°åŒ–æ¸…ç† (å» NBSP, æŠ˜å ç©ºæ ¼, å»ä¸¤ç«¯ç©ºç™½)
                temp = raw.replace("\u00a0", " ")
                temp = re.sub(r" {2,}", " ", temp).strip()
                out = normalize_spacing(temp)  # ä»ç„¶åº”ç”¨ normalize_spacing çš„è§„åˆ™

            print(f"\n\nğŸ“„ æ’ç‰ˆåçš„æ–‡æœ¬å†…å®¹: \n{out}")

    except KeyboardInterrupt:
        print("\nğŸ‘‹ æ”¶åˆ° KeyboardInterrupt, ç¨‹åºé€€å‡ºã€‚ã€‚ã€‚")
        print("*" * 100)


if __name__ == "__main__":
    main()
